<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Build your own PC</title>
<link rel="stylesheet" href="../css/style.css">
</head>
<body>
<main>
<p><em>…where PC obviously stands for Personal Crawler</em>.</p>
<div class="date-created-modified">Created 2020-02-25<br>
Modified 2020-03-18</div>
<hr />
<p>This post contains the source code for a very simple crawler written in Java. You can compile and run it on any file or directory, and it will calculate the frequency of all the words it finds.</p>
<h2 class="title" id="source_code"><a class="anchor" href="#source_code">¶</a>Source code</h2>
<p>Paste the following code in a new file called <code>Crawl.java</code>:</p>
<pre><code>import java.io.*;
import java.util.*;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

class Crawl {
	// Regex used to tokenize the words from a line of text
	private final static Pattern WORDS = Pattern.compile(&quot;\\w+&quot;);

	// The file where we will cache our results
	private final static File INDEX_FILE = new File(&quot;index.bin&quot;);

	// Helper method to determine if a file is a text file or not
	private static boolean isTextFile(File file) {
		String name = file.getName().toLowerCase();
		return name.endsWith(&quot;.txt&quot;)
				|| name.endsWith(&quot;.java&quot;)
				|| name.endsWith(&quot;.c&quot;)
				|| name.endsWith(&quot;.cpp&quot;)
				|| name.endsWith(&quot;.h&quot;)
				|| name.endsWith(&quot;.hpp&quot;)
				|| name.endsWith(&quot;.html&quot;)
				|| name.endsWith(&quot;.css&quot;)
				|| name.endsWith(&quot;.js&quot;);
	}

	// Normalizes a string by converting it to lowercase and removing accents
	private static String normalize(String string) {
		return string.toLowerCase()
				.replace(&quot;á&quot;, &quot;a&quot;)
				.replace(&quot;é&quot;, &quot;e&quot;)
				.replace(&quot;í&quot;, &quot;i&quot;)
				.replace(&quot;ó&quot;, &quot;o&quot;)
				.replace(&quot;ú&quot;, &quot;u&quot;);
	}

	// Recursively fills the map with the count of words found on all the text files
	static void fillWordMap(Map&lt;String, Integer&gt; map, File root) throws IOException {
		// Our file queue begins with the root
		Queue&lt;File&gt; fileQueue = new ArrayDeque&lt;&gt;();
		fileQueue.add(root);

		// For as long as the queue is not empty...
		File file;
		while ((file = fileQueue.poll()) != null) {
			if (!file.exists() || !file.canRead()) {
				// ...ignore files for which we don't have permission...
				System.err.println(&quot;warning: cannot read file: &quot; + file);
			} else if (file.isDirectory()) {
				// ...else if it's a directory, extend our queue with its files...
				File[] files = file.listFiles();
				if (files == null) {
					System.err.println(&quot;warning: cannot list dir: &quot; + file);
				} else {
					fileQueue.addAll(Arrays.asList(files));
				}
			} else if (isTextFile(file)) {
				// ...otherwise, count the words in the file.
				countWordsInFile(map, file);
			}
		}
	}

	// Counts the words in a single file and adds the count to the map.
	public static void countWordsInFile(Map&lt;String, Integer&gt; map, File file) throws IOException {
		BufferedReader reader = new BufferedReader(new FileReader(file));

		String line;
		while ((line = reader.readLine()) != null) {
			Matcher matcher = WORDS.matcher(line);
			while (matcher.find()) {
				String token = normalize(matcher.group());
				Integer count = map.get(token);
				if (count == null) {
					map.put(token, 1);
				} else {
					map.put(token, count + 1);
				}
			}
		}

		reader.close();
	}

	// Prints the map of word count to the desired output stream.
	public static void printWordMap(Map&lt;String, Integer&gt; map, PrintStream writer) {
		List&lt;String&gt; keys = new ArrayList&lt;&gt;(map.keySet());
		Collections.sort(keys);
		for (String key : keys) {
			writer.println(key + &quot;\t&quot; + map.get(key));
		}
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	public static void main(String[] args) throws IOException, ClassNotFoundException {
		// Validate arguments
		if (args.length == 1 &amp;&amp; args[0].equals(&quot;--help&quot;)) {
			System.err.println(&quot;usage: java Crawl [input]&quot;);
			return;
		}

		File root = new File(args.length &gt; 0 ? args[0] : &quot;.&quot;);

		// Loading or generating the map where we aggregate the data  {word: count}
		Map&lt;String, Integer&gt; map;
		if (INDEX_FILE.isFile()) {
			System.err.println(&quot;Found existing index file: &quot; + INDEX_FILE);
			try (ObjectInputStream ois = new ObjectInputStream(new FileInputStream(INDEX_FILE))) {
				map = (Map&lt;String, Integer&gt;) ois.readObject();
			}
		} else {
			System.err.println(&quot;Index file not found: &quot; + INDEX_FILE + &quot;; indexing...&quot;);
			map = new TreeMap&lt;&gt;();
			fillWordMap(map, root);
			// Cache the results to avoid doing the work a next time
			try (ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(INDEX_FILE))) {
				out.writeObject(map);
			}
		}

		// Ask the user in a loop to query for words
		Scanner scanner = new Scanner(System.in);
		while (true) {
			System.out.print(&quot;Escriba palabra a consultar (o Enter para salir): &quot;);
			System.out.flush();
			String line = scanner.nextLine().trim();
			if (line.isEmpty()) {
				break;
			}

			line = normalize(line);
			Integer count = map.get(line);
			if (count == null) {
				System.out.println(String.format(&quot;La palabra \&quot;%s\&quot; no está presente&quot;, line));
			} else if (count == 1) {
				System.out.println(String.format(&quot;La palabra \&quot;%s\&quot; está presente 1 vez&quot;, line));
			} else {
				System.out.println(String.format(&quot;La palabra \&quot;%s\&quot; está presente %d veces&quot;, line, count));
			}
		}
	}
}
</code></pre>
<p>It can be compiled and executed as follows:</p>
<pre><code>javac Crawl.java
java Crawl
</code></pre>
<p>Instead of copy-pasting the code, you may also download it as a <code>.zip</code>:</p>
<p><em>(contents removed)</em></p>
<h2 id="addendum"><a class="anchor" href="#addendum">¶</a>Addendum</h2>
<p>The following simple function can be used if one desires to print the contents of a file:</p>
<pre><code>public static void printFile(File file) {
	if (isTextFile(file)) {
		System.out.println('\n' + file.getName());
		try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
			String line;
			while ((line = reader.readLine()) != null) {
				System.out.println(line);
			}
		} catch (FileNotFoundException ignored) {
			System.err.println(&quot;warning: file disappeared while reading: &quot; + file);
		} catch (IOException e) {
			e.printStackTrace();
		}
	}
}
</code></pre>
</main>
</body>
</html>
 